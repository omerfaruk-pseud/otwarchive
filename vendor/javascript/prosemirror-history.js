// prosemirror-history@1.5.0 downloaded from https://ga.jspm.io/npm:prosemirror-history@1.5.0/dist/index.js

import e from"rope-sequence";import{Mapping as t}from"prosemirror-transform";import{PluginKey as n,Plugin as r}from"prosemirror-state";const s=500;class Branch{constructor(e,t){this.items=e;this.eventCount=t}popEvent(e,t){if(this.eventCount==0)return null;let n=this.items.length;for(;;n--){let e=this.items.get(n-1);if(e.selection){--n;break}}let r,s;if(t){r=this.remapping(n,this.items.length);s=r.maps.length}let i=e.tr;let o,l;let p=[],a=[];this.items.forEach(((e,t)=>{if(e.step){if(r){a.push(new Item(e.map));let t,n=e.step.map(r.slice(s));if(n&&i.maybeStep(n).doc){t=i.mapping.maps[i.mapping.maps.length-1];p.push(new Item(t,void 0,void 0,p.length+a.length))}s--;t&&r.appendMap(t,s)}else i.maybeStep(e.step);if(e.selection){o=r?e.selection.map(r.slice(s)):e.selection;l=new Branch(this.items.slice(0,n).append(a.reverse().concat(p)),this.eventCount-1);return false}}else{if(!r){r=this.remapping(n,t+1);s=r.maps.length}s--;a.push(e)}}),this.items.length,0);return{remaining:l,transform:i,selection:o}}addTransform(e,t,n,r){let s=[],l=this.eventCount;let p=this.items,a=!r&&p.length?p.get(p.length-1):null;for(let n=0;n<e.steps.length;n++){let i=e.steps[n].invert(e.docs[n]);let o,m=new Item(e.mapping.maps[n],i,t);if(o=a&&a.merge(m)){m=o;n?s.pop():p=p.slice(0,p.length-1)}s.push(m);if(t){l++;t=void 0}r||(a=m)}let m=l-n.depth;if(m>o){p=i(p,m);l-=m}return new Branch(p.append(s),l)}remapping(e,n){let r=new t;this.items.forEach(((t,n)=>{let s=t.mirrorOffset!=null&&n-t.mirrorOffset>=e?r.maps.length-t.mirrorOffset:void 0;r.appendMap(t.map,s)}),e,n);return r}addMaps(e){return this.eventCount==0?this:new Branch(this.items.append(e.map((e=>new Item(e)))),this.eventCount)}rebased(e,t){if(!this.eventCount)return this;let n=[],r=Math.max(0,this.items.length-t);let i=e.mapping;let o=e.steps.length;let l=this.eventCount;this.items.forEach((e=>{e.selection&&l--}),r);let p=t;this.items.forEach((t=>{let r=i.getMirror(--p);if(r==null)return;o=Math.min(o,r);let s=i.maps[r];if(t.step){let o=e.steps[r].invert(e.docs[r]);let a=t.selection&&t.selection.map(i.slice(p+1,r));a&&l++;n.push(new Item(s,o,a))}else n.push(new Item(s))}),r);let a=[];for(let e=t;e<o;e++)a.push(new Item(i.maps[e]));let m=this.items.slice(0,r).append(a).append(n);let u=new Branch(m,l);u.emptyItemCount()>s&&(u=u.compress(this.items.length-n.length));return u}emptyItemCount(){let e=0;this.items.forEach((t=>{t.step||e++}));return e}compress(t=this.items.length){let n=this.remapping(0,t),r=n.maps.length;let s=[],i=0;this.items.forEach(((e,o)=>{if(o>=t){s.push(e);e.selection&&i++}else if(e.step){let t=e.step.map(n.slice(r)),o=t&&t.getMap();r--;o&&n.appendMap(o,r);if(t){let l=e.selection&&e.selection.map(n.slice(r));l&&i++;let p,a=new Item(o.invert(),t,l),m=s.length-1;(p=s.length&&s[m].merge(a))?s[m]=p:s.push(a)}}else e.map&&r--}),this.items.length,0);return new Branch(e.from(s.reverse()),i)}}Branch.empty=new Branch(e.empty,0);function i(e,t){let n;e.forEach(((e,r)=>{if(e.selection&&t--==0){n=r;return false}}));return e.slice(n)}class Item{constructor(e,t,n,r){this.map=e;this.step=t;this.selection=n;this.mirrorOffset=r}merge(e){if(this.step&&e.step&&!e.selection){let t=e.step.merge(this.step);if(t)return new Item(t.getMap().invert(),t,this.selection)}}}class HistoryState{constructor(e,t,n,r,s){this.done=e;this.undone=t;this.prevRanges=n;this.prevTime=r;this.prevComposition=s}}const o=20;function l(e,t,n,r){let s,i=n.getMeta(d);if(i)return i.historyState;n.getMeta(v)&&(e=new HistoryState(e.done,e.undone,null,0,-1));let o=n.getMeta("appendedTransaction");if(n.steps.length==0)return e;if(o&&o.getMeta(d))return o.getMeta(d).redo?new HistoryState(e.done.addTransform(n,void 0,r,c(t)),e.undone,a(n.mapping.maps),e.prevTime,e.prevComposition):new HistoryState(e.done,e.undone.addTransform(n,void 0,r,c(t)),null,e.prevTime,e.prevComposition);if(n.getMeta("addToHistory")===false||o&&o.getMeta("addToHistory")===false)return(s=n.getMeta("rebased"))?new HistoryState(e.done.rebased(n,s),e.undone.rebased(n,s),m(e.prevRanges,n.mapping),e.prevTime,e.prevComposition):new HistoryState(e.done.addMaps(n.mapping.maps),e.undone.addMaps(n.mapping.maps),m(e.prevRanges,n.mapping),e.prevTime,e.prevComposition);{let s=n.getMeta("composition");let i=e.prevTime==0||!o&&e.prevComposition!=s&&(e.prevTime<(n.time||0)-r.newGroupDelay||!p(n,e.prevRanges));let l=o?m(e.prevRanges,n.mapping):a(n.mapping.maps);return new HistoryState(e.done.addTransform(n,i?t.selection.getBookmark():void 0,r,c(t)),Branch.empty,l,n.time,s==null?e.prevComposition:s)}}function p(e,t){if(!t)return false;if(!e.docChanged)return true;let n=false;e.mapping.maps[0].forEach(((e,r)=>{for(let s=0;s<t.length;s+=2)e<=t[s+1]&&r>=t[s]&&(n=true)}));return n}function a(e){let t=[];for(let n=e.length-1;n>=0&&t.length==0;n--)e[n].forEach(((e,n,r,s)=>t.push(r,s)));return t}function m(e,t){if(!e)return null;let n=[];for(let r=0;r<e.length;r+=2){let s=t.map(e[r],1),i=t.map(e[r+1],-1);s<=i&&n.push(s,i)}return n}function u(e,t,n){let r=c(t);let s=d.get(t).spec.config;let i=(n?e.undone:e.done).popEvent(t,r);if(!i)return null;let o=i.selection.resolve(i.transform.doc);let l=(n?e.done:e.undone).addTransform(i.transform,t.selection.getBookmark(),s,r);let p=new HistoryState(n?l:i.remaining,n?i.remaining:l,null,0,-1);return i.transform.setSelection(o).setMeta(d,{redo:n,historyState:p})}let h=false,f=null;function c(e){let t=e.plugins;if(f!=t){h=false;f=t;for(let e=0;e<t.length;e++)if(t[e].spec.historyPreserveItems){h=true;break}}return h}function g(e){return e.setMeta(v,true)}const d=new n("history");const v=new n("closeHistory");function y(e={}){e={depth:e.depth||100,newGroupDelay:e.newGroupDelay||500};return new r({key:d,state:{init(){return new HistoryState(Branch.empty,Branch.empty,null,0,-1)},apply(t,n,r){return l(n,r,t,e)}},config:e,props:{handleDOMEvents:{beforeinput(e,t){let n=t.inputType;let r=n=="historyUndo"?M:n=="historyRedo"?C:null;if(!r||!e.editable)return false;t.preventDefault();return r(e.state,e.dispatch)}}}})}function w(e,t){return(n,r)=>{let s=d.getState(n);if(!s||(e?s.undone:s.done).eventCount==0)return false;if(r){let i=u(s,n,e);i&&r(t?i.scrollIntoView():i)}return true}}const M=w(false,true);const C=w(true,true);const S=w(false,false);const T=w(true,false);function I(e){let t=d.getState(e);return t?t.done.eventCount:0}function B(e){let t=d.getState(e);return t?t.undone.eventCount:0}function E(e){return e.getMeta(d)!=null}export{g as closeHistory,y as history,E as isHistoryTransaction,C as redo,B as redoDepth,T as redoNoScroll,M as undo,I as undoDepth,S as undoNoScroll};

