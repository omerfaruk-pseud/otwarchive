// prosemirror-gapcursor@1.4.0 downloaded from https://ga.jspm.io/npm:prosemirror-gapcursor@1.4.0/dist/index.js

import{keydownHandler as e}from"prosemirror-keymap";import{Selection as r,NodeSelection as t,Plugin as o,TextSelection as n}from"prosemirror-state";import{Slice as i,Fragment as s}from"prosemirror-model";import{DecorationSet as l,Decoration as a}from"prosemirror-view";class GapCursor extends r{constructor(e){super(e,e)}map(e,t){let o=e.resolve(t.map(this.head));return GapCursor.valid(o)?new GapCursor(o):r.near(o)}content(){return i.empty}eq(e){return e instanceof GapCursor&&e.head==this.head}toJSON(){return{type:"gapcursor",pos:this.head}}static fromJSON(e,r){if(typeof r.pos!="number")throw new RangeError("Invalid input for GapCursor.fromJSON");return new GapCursor(e.resolve(r.pos))}getBookmark(){return new GapBookmark(this.anchor)}static valid(e){let r=e.parent;if(r.isTextblock||!p(e)||!f(e))return false;let t=r.type.spec.allowGapCursor;if(t!=null)return t;let o=r.contentMatchAt(e.index()).defaultType;return o&&o.isTextblock}static findGapCursorFrom(e,r,o=false){e:for(;;){if(!o&&GapCursor.valid(e))return e;let n=e.pos,i=null;for(let t=e.depth;;t--){let o=e.node(t);if(r>0?e.indexAfter(t)<o.childCount:e.index(t)>0){i=o.child(r>0?e.indexAfter(t):e.index(t)-1);break}if(t==0)return null;n+=r;let s=e.doc.resolve(n);if(GapCursor.valid(s))return s}for(;;){let s=r>0?i.firstChild:i.lastChild;if(!s){if(i.isAtom&&!i.isText&&!t.isSelectable(i)){e=e.doc.resolve(n+i.nodeSize*r);o=false;continue e}break}i=s;n+=r;let l=e.doc.resolve(n);if(GapCursor.valid(l))return l}return null}}}GapCursor.prototype.visible=false;GapCursor.findFrom=GapCursor.findGapCursorFrom;r.jsonID("gapcursor",GapCursor);class GapBookmark{constructor(e){this.pos=e}map(e){return new GapBookmark(e.map(this.pos))}resolve(e){let t=e.resolve(this.pos);return GapCursor.valid(t)?new GapCursor(t):r.near(t)}}function u(e){return e.isAtom||e.spec.isolating||e.spec.createGapCursor}function p(e){for(let r=e.depth;r>=0;r--){let t=e.index(r),o=e.node(r);if(t!=0)for(let e=o.child(t-1);;e=e.lastChild){if(e.childCount==0&&!e.inlineContent||u(e.type))return true;if(e.inlineContent)return false}else if(o.type.spec.isolating)return true}return true}function f(e){for(let r=e.depth;r>=0;r--){let t=e.indexAfter(r),o=e.node(r);if(t!=o.childCount)for(let e=o.child(t);;e=e.firstChild){if(e.childCount==0&&!e.inlineContent||u(e.type))return true;if(e.inlineContent)return false}else if(o.type.spec.isolating)return true}return true}function c(){return new o({props:{decorations:G,createSelectionBetween(e,r,t){return r.pos==t.pos&&GapCursor.valid(t)?new GapCursor(t):null},handleClick:h,handleKeyDown:d,handleDOMEvents:{beforeinput:m}}})}const d=e({ArrowLeft:C("horiz",-1),ArrowRight:C("horiz",1),ArrowUp:C("vert",-1),ArrowDown:C("vert",1)});function C(e,r){const t=e=="vert"?r>0?"down":"up":r>0?"right":"left";return function(e,o,i){let s=e.selection;let l=r>0?s.$to:s.$from,a=s.empty;if(s instanceof n){if(!i.endOfTextblock(t)||l.depth==0)return false;a=false;l=e.doc.resolve(r>0?l.after():l.before())}let u=GapCursor.findGapCursorFrom(l,r,a);if(!u)return false;o&&o(e.tr.setSelection(new GapCursor(u)));return true}}function h(e,r,o){if(!e||!e.editable)return false;let n=e.state.doc.resolve(r);if(!GapCursor.valid(n))return false;let i=e.posAtCoords({left:o.clientX,top:o.clientY});if(i&&i.inside>-1&&t.isSelectable(e.state.doc.nodeAt(i.inside)))return false;e.dispatch(e.state.tr.setSelection(new GapCursor(n)));return true}function m(e,r){if(r.inputType!="insertCompositionText"||!(e.state.selection instanceof GapCursor))return false;let{$from:t}=e.state.selection;let o=t.parent.contentMatchAt(t.index()).findWrapping(e.state.schema.nodes.text);if(!o)return false;let l=s.empty;for(let e=o.length-1;e>=0;e--)l=s.from(o[e].createAndFill(null,l));let a=e.state.tr.replace(t.pos,t.pos,new i(l,0,0));a.setSelection(n.near(a.doc.resolve(t.pos+1)));e.dispatch(a);return false}function G(e){if(!(e.selection instanceof GapCursor))return null;let r=document.createElement("div");r.className="ProseMirror-gapcursor";return l.create(e.doc,[a.widget(e.selection.head,r,{key:"gapcursor"})])}export{GapCursor,c as gapCursor};

